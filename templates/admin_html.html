<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>컨스낵 관리자</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $.ajax({
          type: "GET",
          url: "/api/admin",
          data: {},
          success: function (response) {
            if (response["result"] == "success") {
              let orders = response["orders"];
              orders = orders.reverse();
              for (let i = 0; i < orders.length; i++) {
                // orders[i]['time'] = orders[i]['time'].getFullYear() + '-' +('0' + (orders[i]['time'].getMonth()+1)).slice(-2)+ '-' +  ('0' + orders[i]['time'].getDate()).slice(-2) + ' '+orders[i]['time'].getHours()+ ':'+('0' + (orders[i]['time'].getMinutes())).slice(-2)+ ':'+orders[i]['time'].getSeconds()
                var temp_html = `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${orders[i]["time"]}</td>
                                <td>${orders[i]["name"]}</td>
                                <td>${orders[i]["price"]}</td>
                                <td>${orders[i]["qty"]}</td>
                            </tr>
                            `;
                $("#orders-box").append(temp_html);
              }
            } else {
              alert("주문 내역을 받아오지 못했습니다.");
            }
          },
        });
      });

      function fnExcelReport(id, title) {

        var tab_text =
          '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
        tab_text =
          tab_text +
          '<head><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">';
        tab_text =
          tab_text +
          "<xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>";
        tab_text = tab_text + "<x:Name>orders</x:Name>";
        tab_text =
          tab_text +
          "<x:WorksheetOptions><x:Panes></x:Panes></x:WorksheetOptions></x:ExcelWorksheet>";
        tab_text =
          tab_text +
          "</x:ExcelWorksheets></x:ExcelWorkbook></xml></head><body>";
        tab_text = tab_text + "<table border='1px'>";
        var exportTable = $("#" + id).clone();
        exportTable.find("input").each(function (index, elem) {
          $(elem).remove();
        });
        tab_text = tab_text + exportTable.html();
        tab_text = tab_text + "</table></body></html>";
        var data_type = "data:application/vnd.ms-excel";
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");
        var fileName = title + ".xls";
        //Explorer 환경에서 다운로드
        if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./)) {
          if (window.navigator.msSaveBlob) {
            var blob = new Blob([tab_text], {
              type: "application/csv;charset=utf-8;",
            });
            navigator.msSaveBlob(blob, fileName);
          }
        } else {
          var blob2 = new Blob([tab_text], {
            type: "application/csv;charset=utf-8;",
          });
          var filename = fileName;
          var elem = window.document.createElement("a");
          elem.href = window.URL.createObjectURL(blob2);
          elem.download = filename;
          document.body.appendChild(elem);
          elem.click();
          document.body.removeChild(elem);
        }
      }
    </script>
  </head>

  <body>
    <button type="button" onclick="fnExcelReport('orders-box','consnack');">
      Excel Download
    </button>
    <table>
      <thead>
        <tr>
          <th>No.</th>
          <th>주문일시</th>
          <th>상품명</th>
          <th>개당 가격(원)</th>
          <th>주문 수량</th>
        </tr>
      </thead>
      <tbody id="orders-box"></tbody>
    </table>
  </body>
</html>
